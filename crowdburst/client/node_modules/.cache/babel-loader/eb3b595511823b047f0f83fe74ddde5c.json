{"ast":null,"code":"'use strict';\n\nvar _classCallCheck = require(\"/Users/S/Desktop/nodeprotake2/crowdburst/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/S/Desktop/nodeprotake2/crowdburst/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar _inherits = require(\"/Users/S/Desktop/nodeprotake2/crowdburst/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/inherits\");\n\nvar _createSuper = require(\"/Users/S/Desktop/nodeprotake2/crowdburst/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createSuper\");\n\nvar EventEmitter = require('events'),\n    MongoError = require('../core').MongoError,\n    f = require('util').format,\n    translateReadPreference = require('../utils').translateReadPreference,\n    ClientSession = require('../core').Sessions.ClientSession; // The store of ops\n\n\nvar Store = function Store(topology, storeOptions) {\n  var self = this;\n  var storedOps = [];\n  storeOptions = storeOptions || {\n    force: false,\n    bufferMaxEntries: -1\n  }; // Internal state\n\n  this.s = {\n    storedOps: storedOps,\n    storeOptions: storeOptions,\n    topology: topology\n  };\n  Object.defineProperty(this, 'length', {\n    enumerable: true,\n    get: function get() {\n      return self.s.storedOps.length;\n    }\n  });\n};\n\nStore.prototype.add = function (opType, ns, ops, options, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({\n      message: 'db closed by application',\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(MongoError.create({\n      message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries > 0 && this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(MongoError.create({\n        message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n        driver: true\n      }));\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({\n    t: opType,\n    n: ns,\n    o: ops,\n    op: options,\n    c: callback\n  });\n};\n\nStore.prototype.addObjectAndMethod = function (opType, object, method, params, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({\n      message: 'db closed by application',\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(MongoError.create({\n      message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries > 0 && this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(MongoError.create({\n        message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n        driver: true\n      }));\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({\n    t: opType,\n    m: method,\n    o: object,\n    p: params,\n    c: callback\n  });\n};\n\nStore.prototype.flush = function (err) {\n  while (this.s.storedOps.length > 0) {\n    this.s.storedOps.shift().c(err || MongoError.create({\n      message: f('no connection available for operation'),\n      driver: true\n    }));\n  }\n};\n\nvar primaryOptions = ['primary', 'primaryPreferred', 'nearest', 'secondaryPreferred'];\nvar secondaryOptions = ['secondary', 'secondaryPreferred'];\n\nStore.prototype.execute = function (options) {\n  options = options || {}; // Get current ops\n\n  var ops = this.s.storedOps; // Reset the ops\n\n  this.s.storedOps = []; // Unpack options\n\n  var executePrimary = typeof options.executePrimary === 'boolean' ? options.executePrimary : true;\n  var executeSecondary = typeof options.executeSecondary === 'boolean' ? options.executeSecondary : true; // Execute all the stored ops\n\n  while (ops.length > 0) {\n    var op = ops.shift();\n\n    if (op.t === 'cursor') {\n      if (executePrimary && executeSecondary) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (executePrimary && op.o.options && op.o.options.readPreference && primaryOptions.indexOf(op.o.options.readPreference.mode) !== -1) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (!executePrimary && executeSecondary && op.o.options && op.o.options.readPreference && secondaryOptions.indexOf(op.o.options.readPreference.mode) !== -1) {\n        op.o[op.m].apply(op.o, op.p);\n      }\n    } else if (op.t === 'auth') {\n      this.s.topology[op.t].apply(this.s.topology, op.o);\n    } else {\n      if (executePrimary && executeSecondary) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (executePrimary && op.op && op.op.readPreference && primaryOptions.indexOf(op.op.readPreference.mode) !== -1) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (!executePrimary && executeSecondary && op.op && op.op.readPreference && secondaryOptions.indexOf(op.op.readPreference.mode) !== -1) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      }\n    }\n  }\n};\n\nStore.prototype.all = function () {\n  return this.s.storedOps;\n}; // Server capabilities\n\n\nvar ServerCapabilities = function ServerCapabilities(ismaster) {\n  var setup_get_property = function setup_get_property(object, name, value) {\n    Object.defineProperty(object, name, {\n      enumerable: true,\n      get: function get() {\n        return value;\n      }\n    });\n  }; // Capabilities\n\n\n  var aggregationCursor = false;\n  var writeCommands = false;\n  var textSearch = false;\n  var authCommands = false;\n  var listCollections = false;\n  var listIndexes = false;\n  var maxNumberOfDocsInBatch = ismaster.maxWriteBatchSize || 1000;\n  var commandsTakeWriteConcern = false;\n  var commandsTakeCollation = false;\n\n  if (ismaster.minWireVersion >= 0) {\n    textSearch = true;\n  }\n\n  if (ismaster.maxWireVersion >= 1) {\n    aggregationCursor = true;\n    authCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 2) {\n    writeCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 3) {\n    listCollections = true;\n    listIndexes = true;\n  }\n\n  if (ismaster.maxWireVersion >= 5) {\n    commandsTakeWriteConcern = true;\n    commandsTakeCollation = true;\n  } // If no min or max wire version set to 0\n\n\n  if (ismaster.minWireVersion == null) {\n    ismaster.minWireVersion = 0;\n  }\n\n  if (ismaster.maxWireVersion == null) {\n    ismaster.maxWireVersion = 0;\n  } // Map up read only parameters\n\n\n  setup_get_property(this, 'hasAggregationCursor', aggregationCursor);\n  setup_get_property(this, 'hasWriteCommands', writeCommands);\n  setup_get_property(this, 'hasTextSearch', textSearch);\n  setup_get_property(this, 'hasAuthCommands', authCommands);\n  setup_get_property(this, 'hasListCollectionsCommand', listCollections);\n  setup_get_property(this, 'hasListIndexesCommand', listIndexes);\n  setup_get_property(this, 'minWireVersion', ismaster.minWireVersion);\n  setup_get_property(this, 'maxWireVersion', ismaster.maxWireVersion);\n  setup_get_property(this, 'maxNumberOfDocsInBatch', maxNumberOfDocsInBatch);\n  setup_get_property(this, 'commandsTakeWriteConcern', commandsTakeWriteConcern);\n  setup_get_property(this, 'commandsTakeCollation', commandsTakeCollation);\n};\n\nvar TopologyBase = /*#__PURE__*/function (_EventEmitter) {\n  _inherits(TopologyBase, _EventEmitter);\n\n  var _super = _createSuper(TopologyBase);\n\n  function TopologyBase() {\n    var _this;\n\n    _classCallCheck(this, TopologyBase);\n\n    _this = _super.call(this);\n\n    _this.setMaxListeners(Infinity);\n\n    return _this;\n  } // Sessions related methods\n\n\n  _createClass(TopologyBase, [{\n    key: \"hasSessionSupport\",\n    value: function hasSessionSupport() {\n      return this.logicalSessionTimeoutMinutes != null;\n    }\n  }, {\n    key: \"startSession\",\n    value: function startSession(options, clientOptions) {\n      var _this2 = this;\n\n      var session = new ClientSession(this, this.s.sessionPool, options, clientOptions);\n      session.once('ended', function () {\n        _this2.s.sessions.delete(session);\n      });\n      this.s.sessions.add(session);\n      return session;\n    }\n  }, {\n    key: \"endSessions\",\n    value: function endSessions(sessions, callback) {\n      return this.s.coreTopology.endSessions(sessions, callback);\n    }\n  }, {\n    key: \"capabilities\",\n    // Server capabilities\n    value: function capabilities() {\n      if (this.s.sCapabilities) return this.s.sCapabilities;\n      if (this.s.coreTopology.lastIsMaster() == null) return null;\n      this.s.sCapabilities = new ServerCapabilities(this.s.coreTopology.lastIsMaster());\n      return this.s.sCapabilities;\n    } // Command\n\n  }, {\n    key: \"command\",\n    value: function command(ns, cmd, options, callback) {\n      this.s.coreTopology.command(ns.toString(), cmd, translateReadPreference(options), callback);\n    } // Insert\n\n  }, {\n    key: \"insert\",\n    value: function insert(ns, ops, options, callback) {\n      this.s.coreTopology.insert(ns.toString(), ops, options, callback);\n    } // Update\n\n  }, {\n    key: \"update\",\n    value: function update(ns, ops, options, callback) {\n      this.s.coreTopology.update(ns.toString(), ops, options, callback);\n    } // Remove\n\n  }, {\n    key: \"remove\",\n    value: function remove(ns, ops, options, callback) {\n      this.s.coreTopology.remove(ns.toString(), ops, options, callback);\n    } // IsConnected\n\n  }, {\n    key: \"isConnected\",\n    value: function isConnected(options) {\n      options = options || {};\n      options = translateReadPreference(options);\n      return this.s.coreTopology.isConnected(options);\n    } // IsDestroyed\n\n  }, {\n    key: \"isDestroyed\",\n    value: function isDestroyed() {\n      return this.s.coreTopology.isDestroyed();\n    } // Cursor\n\n  }, {\n    key: \"cursor\",\n    value: function cursor(ns, cmd, options) {\n      options = options || {};\n      options = translateReadPreference(options);\n      options.disconnectHandler = this.s.store;\n      options.topology = this;\n      return this.s.coreTopology.cursor(ns, cmd, options);\n    }\n  }, {\n    key: \"lastIsMaster\",\n    value: function lastIsMaster() {\n      return this.s.coreTopology.lastIsMaster();\n    }\n  }, {\n    key: \"selectServer\",\n    value: function selectServer(selector, options, callback) {\n      return this.s.coreTopology.selectServer(selector, options, callback);\n    }\n    /**\n     * Unref all sockets\n     * @method\n     */\n\n  }, {\n    key: \"unref\",\n    value: function unref() {\n      return this.s.coreTopology.unref();\n    }\n    /**\n     * All raw connections\n     * @method\n     * @return {array}\n     */\n\n  }, {\n    key: \"connections\",\n    value: function connections() {\n      return this.s.coreTopology.connections();\n    }\n  }, {\n    key: \"close\",\n    value: function close(forceClosed, callback) {\n      // If we have sessions, we want to individually move them to the session pool,\n      // and then send a single endSessions call.\n      this.s.sessions.forEach(function (session) {\n        return session.endSession();\n      });\n\n      if (this.s.sessionPool) {\n        this.s.sessionPool.endAllPooledSessions();\n      } // We need to wash out all stored processes\n\n\n      if (forceClosed === true) {\n        this.s.storeOptions.force = forceClosed;\n        this.s.store.flush();\n      }\n\n      this.s.coreTopology.destroy({\n        force: typeof forceClosed === 'boolean' ? forceClosed : false\n      }, callback);\n    }\n  }, {\n    key: \"clientMetadata\",\n    get: function get() {\n      return this.s.coreTopology.s.options.metadata;\n    }\n  }]);\n\n  return TopologyBase;\n}(EventEmitter); // Properties\n\n\nObject.defineProperty(TopologyBase.prototype, 'bson', {\n  enumerable: true,\n  get: function get() {\n    return this.s.coreTopology.s.bson;\n  }\n});\nObject.defineProperty(TopologyBase.prototype, 'parserType', {\n  enumerable: true,\n  get: function get() {\n    return this.s.coreTopology.parserType;\n  }\n});\nObject.defineProperty(TopologyBase.prototype, 'logicalSessionTimeoutMinutes', {\n  enumerable: true,\n  get: function get() {\n    return this.s.coreTopology.logicalSessionTimeoutMinutes;\n  }\n});\nObject.defineProperty(TopologyBase.prototype, 'type', {\n  enumerable: true,\n  get: function get() {\n    return this.s.coreTopology.type;\n  }\n});\nexports.Store = Store;\nexports.ServerCapabilities = ServerCapabilities;\nexports.TopologyBase = TopologyBase;","map":{"version":3,"sources":["/Users/S/Desktop/nodeprotake2/node_modules/mongodb/lib/topologies/topology_base.js"],"names":["EventEmitter","require","MongoError","f","format","translateReadPreference","ClientSession","Sessions","Store","topology","storeOptions","self","storedOps","force","bufferMaxEntries","s","Object","defineProperty","enumerable","get","length","prototype","add","opType","ns","ops","options","callback","create","message","driver","op","shift","c","push","t","n","o","addObjectAndMethod","object","method","params","m","p","flush","err","primaryOptions","secondaryOptions","execute","executePrimary","executeSecondary","apply","readPreference","indexOf","mode","all","ServerCapabilities","ismaster","setup_get_property","name","value","aggregationCursor","writeCommands","textSearch","authCommands","listCollections","listIndexes","maxNumberOfDocsInBatch","maxWriteBatchSize","commandsTakeWriteConcern","commandsTakeCollation","minWireVersion","maxWireVersion","TopologyBase","setMaxListeners","Infinity","logicalSessionTimeoutMinutes","clientOptions","session","sessionPool","once","sessions","delete","coreTopology","endSessions","sCapabilities","lastIsMaster","cmd","command","toString","insert","update","remove","isConnected","isDestroyed","disconnectHandler","store","cursor","selector","selectServer","unref","connections","forceClosed","forEach","endSession","endAllPooledSessions","destroy","metadata","bson","parserType","type","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nconst EventEmitter = require('events'),\n  MongoError = require('../core').MongoError,\n  f = require('util').format,\n  translateReadPreference = require('../utils').translateReadPreference,\n  ClientSession = require('../core').Sessions.ClientSession;\n\n// The store of ops\nvar Store = function(topology, storeOptions) {\n  var self = this;\n  var storedOps = [];\n  storeOptions = storeOptions || { force: false, bufferMaxEntries: -1 };\n\n  // Internal state\n  this.s = {\n    storedOps: storedOps,\n    storeOptions: storeOptions,\n    topology: topology\n  };\n\n  Object.defineProperty(this, 'length', {\n    enumerable: true,\n    get: function() {\n      return self.s.storedOps.length;\n    }\n  });\n};\n\nStore.prototype.add = function(opType, ns, ops, options, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({ message: 'db closed by application', driver: true }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(\n      MongoError.create({\n        message: f(\n          'no connection available for operation and number of stored operation > %s',\n          this.s.storeOptions.bufferMaxEntries\n        ),\n        driver: true\n      })\n    );\n  }\n\n  if (\n    this.s.storeOptions.bufferMaxEntries > 0 &&\n    this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries\n  ) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(\n        MongoError.create({\n          message: f(\n            'no connection available for operation and number of stored operation > %s',\n            this.s.storeOptions.bufferMaxEntries\n          ),\n          driver: true\n        })\n      );\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({ t: opType, n: ns, o: ops, op: options, c: callback });\n};\n\nStore.prototype.addObjectAndMethod = function(opType, object, method, params, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({ message: 'db closed by application', driver: true }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(\n      MongoError.create({\n        message: f(\n          'no connection available for operation and number of stored operation > %s',\n          this.s.storeOptions.bufferMaxEntries\n        ),\n        driver: true\n      })\n    );\n  }\n\n  if (\n    this.s.storeOptions.bufferMaxEntries > 0 &&\n    this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries\n  ) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(\n        MongoError.create({\n          message: f(\n            'no connection available for operation and number of stored operation > %s',\n            this.s.storeOptions.bufferMaxEntries\n          ),\n          driver: true\n        })\n      );\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({ t: opType, m: method, o: object, p: params, c: callback });\n};\n\nStore.prototype.flush = function(err) {\n  while (this.s.storedOps.length > 0) {\n    this.s.storedOps\n      .shift()\n      .c(\n        err ||\n          MongoError.create({ message: f('no connection available for operation'), driver: true })\n      );\n  }\n};\n\nvar primaryOptions = ['primary', 'primaryPreferred', 'nearest', 'secondaryPreferred'];\nvar secondaryOptions = ['secondary', 'secondaryPreferred'];\n\nStore.prototype.execute = function(options) {\n  options = options || {};\n  // Get current ops\n  var ops = this.s.storedOps;\n  // Reset the ops\n  this.s.storedOps = [];\n\n  // Unpack options\n  var executePrimary = typeof options.executePrimary === 'boolean' ? options.executePrimary : true;\n  var executeSecondary =\n    typeof options.executeSecondary === 'boolean' ? options.executeSecondary : true;\n\n  // Execute all the stored ops\n  while (ops.length > 0) {\n    var op = ops.shift();\n\n    if (op.t === 'cursor') {\n      if (executePrimary && executeSecondary) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (\n        executePrimary &&\n        op.o.options &&\n        op.o.options.readPreference &&\n        primaryOptions.indexOf(op.o.options.readPreference.mode) !== -1\n      ) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (\n        !executePrimary &&\n        executeSecondary &&\n        op.o.options &&\n        op.o.options.readPreference &&\n        secondaryOptions.indexOf(op.o.options.readPreference.mode) !== -1\n      ) {\n        op.o[op.m].apply(op.o, op.p);\n      }\n    } else if (op.t === 'auth') {\n      this.s.topology[op.t].apply(this.s.topology, op.o);\n    } else {\n      if (executePrimary && executeSecondary) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (\n        executePrimary &&\n        op.op &&\n        op.op.readPreference &&\n        primaryOptions.indexOf(op.op.readPreference.mode) !== -1\n      ) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (\n        !executePrimary &&\n        executeSecondary &&\n        op.op &&\n        op.op.readPreference &&\n        secondaryOptions.indexOf(op.op.readPreference.mode) !== -1\n      ) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      }\n    }\n  }\n};\n\nStore.prototype.all = function() {\n  return this.s.storedOps;\n};\n\n// Server capabilities\nvar ServerCapabilities = function(ismaster) {\n  var setup_get_property = function(object, name, value) {\n    Object.defineProperty(object, name, {\n      enumerable: true,\n      get: function() {\n        return value;\n      }\n    });\n  };\n\n  // Capabilities\n  var aggregationCursor = false;\n  var writeCommands = false;\n  var textSearch = false;\n  var authCommands = false;\n  var listCollections = false;\n  var listIndexes = false;\n  var maxNumberOfDocsInBatch = ismaster.maxWriteBatchSize || 1000;\n  var commandsTakeWriteConcern = false;\n  var commandsTakeCollation = false;\n\n  if (ismaster.minWireVersion >= 0) {\n    textSearch = true;\n  }\n\n  if (ismaster.maxWireVersion >= 1) {\n    aggregationCursor = true;\n    authCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 2) {\n    writeCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 3) {\n    listCollections = true;\n    listIndexes = true;\n  }\n\n  if (ismaster.maxWireVersion >= 5) {\n    commandsTakeWriteConcern = true;\n    commandsTakeCollation = true;\n  }\n\n  // If no min or max wire version set to 0\n  if (ismaster.minWireVersion == null) {\n    ismaster.minWireVersion = 0;\n  }\n\n  if (ismaster.maxWireVersion == null) {\n    ismaster.maxWireVersion = 0;\n  }\n\n  // Map up read only parameters\n  setup_get_property(this, 'hasAggregationCursor', aggregationCursor);\n  setup_get_property(this, 'hasWriteCommands', writeCommands);\n  setup_get_property(this, 'hasTextSearch', textSearch);\n  setup_get_property(this, 'hasAuthCommands', authCommands);\n  setup_get_property(this, 'hasListCollectionsCommand', listCollections);\n  setup_get_property(this, 'hasListIndexesCommand', listIndexes);\n  setup_get_property(this, 'minWireVersion', ismaster.minWireVersion);\n  setup_get_property(this, 'maxWireVersion', ismaster.maxWireVersion);\n  setup_get_property(this, 'maxNumberOfDocsInBatch', maxNumberOfDocsInBatch);\n  setup_get_property(this, 'commandsTakeWriteConcern', commandsTakeWriteConcern);\n  setup_get_property(this, 'commandsTakeCollation', commandsTakeCollation);\n};\n\nclass TopologyBase extends EventEmitter {\n  constructor() {\n    super();\n    this.setMaxListeners(Infinity);\n  }\n\n  // Sessions related methods\n  hasSessionSupport() {\n    return this.logicalSessionTimeoutMinutes != null;\n  }\n\n  startSession(options, clientOptions) {\n    const session = new ClientSession(this, this.s.sessionPool, options, clientOptions);\n\n    session.once('ended', () => {\n      this.s.sessions.delete(session);\n    });\n\n    this.s.sessions.add(session);\n    return session;\n  }\n\n  endSessions(sessions, callback) {\n    return this.s.coreTopology.endSessions(sessions, callback);\n  }\n\n  get clientMetadata() {\n    return this.s.coreTopology.s.options.metadata;\n  }\n\n  // Server capabilities\n  capabilities() {\n    if (this.s.sCapabilities) return this.s.sCapabilities;\n    if (this.s.coreTopology.lastIsMaster() == null) return null;\n    this.s.sCapabilities = new ServerCapabilities(this.s.coreTopology.lastIsMaster());\n    return this.s.sCapabilities;\n  }\n\n  // Command\n  command(ns, cmd, options, callback) {\n    this.s.coreTopology.command(ns.toString(), cmd, translateReadPreference(options), callback);\n  }\n\n  // Insert\n  insert(ns, ops, options, callback) {\n    this.s.coreTopology.insert(ns.toString(), ops, options, callback);\n  }\n\n  // Update\n  update(ns, ops, options, callback) {\n    this.s.coreTopology.update(ns.toString(), ops, options, callback);\n  }\n\n  // Remove\n  remove(ns, ops, options, callback) {\n    this.s.coreTopology.remove(ns.toString(), ops, options, callback);\n  }\n\n  // IsConnected\n  isConnected(options) {\n    options = options || {};\n    options = translateReadPreference(options);\n\n    return this.s.coreTopology.isConnected(options);\n  }\n\n  // IsDestroyed\n  isDestroyed() {\n    return this.s.coreTopology.isDestroyed();\n  }\n\n  // Cursor\n  cursor(ns, cmd, options) {\n    options = options || {};\n    options = translateReadPreference(options);\n    options.disconnectHandler = this.s.store;\n    options.topology = this;\n\n    return this.s.coreTopology.cursor(ns, cmd, options);\n  }\n\n  lastIsMaster() {\n    return this.s.coreTopology.lastIsMaster();\n  }\n\n  selectServer(selector, options, callback) {\n    return this.s.coreTopology.selectServer(selector, options, callback);\n  }\n\n  /**\n   * Unref all sockets\n   * @method\n   */\n  unref() {\n    return this.s.coreTopology.unref();\n  }\n\n  /**\n   * All raw connections\n   * @method\n   * @return {array}\n   */\n  connections() {\n    return this.s.coreTopology.connections();\n  }\n\n  close(forceClosed, callback) {\n    // If we have sessions, we want to individually move them to the session pool,\n    // and then send a single endSessions call.\n    this.s.sessions.forEach(session => session.endSession());\n\n    if (this.s.sessionPool) {\n      this.s.sessionPool.endAllPooledSessions();\n    }\n\n    // We need to wash out all stored processes\n    if (forceClosed === true) {\n      this.s.storeOptions.force = forceClosed;\n      this.s.store.flush();\n    }\n\n    this.s.coreTopology.destroy(\n      {\n        force: typeof forceClosed === 'boolean' ? forceClosed : false\n      },\n      callback\n    );\n  }\n}\n\n// Properties\nObject.defineProperty(TopologyBase.prototype, 'bson', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.s.bson;\n  }\n});\n\nObject.defineProperty(TopologyBase.prototype, 'parserType', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.parserType;\n  }\n});\n\nObject.defineProperty(TopologyBase.prototype, 'logicalSessionTimeoutMinutes', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.logicalSessionTimeoutMinutes;\n  }\n});\n\nObject.defineProperty(TopologyBase.prototype, 'type', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.type;\n  }\n});\n\nexports.Store = Store;\nexports.ServerCapabilities = ServerCapabilities;\nexports.TopologyBase = TopologyBase;\n"]},"metadata":{},"sourceType":"script"}
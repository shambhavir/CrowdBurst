{"ast":null,"code":"import JWT from \"./JWT\";\nvar SLEEP_MILLIS = 60000;\nvar EXPIRATION_WINDOW_SECS = 300;\n\nvar AccessTokenRefresher = function () {\n  function AccessTokenRefresher(auth) {\n    this.auth = auth;\n  }\n\n  AccessTokenRefresher.prototype.shouldRefresh = function () {\n    var auth = this.auth;\n\n    if (auth === undefined) {\n      return false;\n    }\n\n    if (!auth.isLoggedIn) {\n      return false;\n    }\n\n    var info = auth.authInfo;\n\n    if (info === undefined) {\n      return false;\n    }\n\n    if (!info.isLoggedIn) {\n      return false;\n    }\n\n    var jwt;\n\n    try {\n      jwt = JWT.fromEncoded(info.accessToken);\n    } catch (e) {\n      console.log(e);\n      return false;\n    }\n\n    if (Date.now() / 1000 < jwt.expires - EXPIRATION_WINDOW_SECS) {\n      return false;\n    }\n\n    return true;\n  };\n\n  AccessTokenRefresher.prototype.run = function () {\n    var _this = this;\n\n    if (!this.shouldRefresh()) {\n      this.nextTimeout = setTimeout(function () {\n        return _this.run();\n      }, SLEEP_MILLIS);\n    } else {\n      this.auth.refreshAccessToken().then(function () {\n        _this.nextTimeout = setTimeout(function () {\n          return _this.run();\n        }, SLEEP_MILLIS);\n      }).catch(function () {\n        _this.nextTimeout = setTimeout(function () {\n          return _this.run();\n        }, SLEEP_MILLIS);\n      });\n    }\n  };\n\n  AccessTokenRefresher.prototype.stop = function () {\n    clearTimeout(this.nextTimeout);\n  };\n\n  return AccessTokenRefresher;\n}();\n\nexport default AccessTokenRefresher;","map":{"version":3,"sources":["../../../../src/auth/internal/AccessTokenRefresher.ts"],"names":[],"mappings":"AAmBA,OAAO,GAAP,MAAgB,OAAhB;AAEA,IAAM,YAAY,GAAG,KAArB;AACA,IAAM,sBAAsB,GAAG,GAA/B;;AAOA,IAAA,oBAAA,GAAA,YAAA;AAQE,WAAA,oBAAA,CAAY,IAAZ,EAAmC;AACjC,SAAK,IAAL,GAAY,IAAZ;AACD;;AAOM,EAAA,oBAAA,CAAA,SAAA,CAAA,aAAA,GAAP,YAAA;AACE,QAAM,IAAI,GAAG,KAAK,IAAlB;;AACA,QAAI,IAAI,KAAK,SAAb,EAAwB;AACtB,aAAO,KAAP;AACD;;AAED,QAAI,CAAC,IAAI,CAAC,UAAV,EAAsB;AACpB,aAAO,KAAP;AACD;;AAED,QAAM,IAAI,GAAG,IAAI,CAAC,QAAlB;;AACA,QAAI,IAAI,KAAK,SAAb,EAAwB;AACtB,aAAO,KAAP;AACD;;AAED,QAAI,CAAC,IAAI,CAAC,UAAV,EAAsB;AACpB,aAAO,KAAP;AACD;;AAED,QAAI,GAAJ;;AACA,QAAI;AACF,MAAA,GAAG,GAAG,GAAG,CAAC,WAAJ,CAAgB,IAAI,CAAC,WAArB,CAAN;AACD,KAFD,CAEE,OAAO,CAAP,EAAU;AAEV,MAAA,OAAO,CAAC,GAAR,CAAY,CAAZ;AAEA,aAAO,KAAP;AACD;;AAGD,QAAI,IAAI,CAAC,GAAL,KAAa,IAAb,GAAoB,GAAG,CAAC,OAAJ,GAAc,sBAAtC,EAA8D;AAC5D,aAAO,KAAP;AACD;;AAED,WAAO,IAAP;AACD,GAnCM;;AA0CA,EAAA,oBAAA,CAAA,SAAA,CAAA,GAAA,GAAP,YAAA;AAAA,QAAA,KAAA,GAAA,IAAA;;AACE,QAAI,CAAC,KAAK,aAAL,EAAL,EAA2B;AACzB,WAAK,WAAL,GAAmB,UAAU,CAAC,YAAA;AAAM,eAAA,KAAI,CAAJ,GAAA,EAAA;AAAU,OAAjB,EAAmB,YAAnB,CAA7B;AACD,KAFD,MAEO;AACL,WAAK,IAAL,CAAU,kBAAV,GAA+B,IAA/B,CAAoC,YAAA;AAClC,QAAA,KAAI,CAAC,WAAL,GAAmB,UAAU,CAAC,YAAA;AAAM,iBAAA,KAAI,CAAJ,GAAA,EAAA;AAAU,SAAjB,EAAmB,YAAnB,CAA7B;AACD,OAFD,EAEG,KAFH,CAES,YAAA;AACP,QAAA,KAAI,CAAC,WAAL,GAAmB,UAAU,CAAC,YAAA;AAAM,iBAAA,KAAI,CAAJ,GAAA,EAAA;AAAU,SAAjB,EAAmB,YAAnB,CAA7B;AACD,OAJD;AAKD;AACF,GAVM;;AAeA,EAAA,oBAAA,CAAA,SAAA,CAAA,IAAA,GAAP,YAAA;AACE,IAAA,YAAY,CAAC,KAAK,WAAN,CAAZ;AACD,GAFM;;AAGT,SAAA,oBAAA;AAAC,CA7ED,EAAA","sourceRoot":"","sourcesContent":["import JWT from \"./JWT\";\nvar SLEEP_MILLIS = 60000;\nvar EXPIRATION_WINDOW_SECS = 300;\nvar AccessTokenRefresher = (function () {\n    function AccessTokenRefresher(auth) {\n        this.auth = auth;\n    }\n    AccessTokenRefresher.prototype.shouldRefresh = function () {\n        var auth = this.auth;\n        if (auth === undefined) {\n            return false;\n        }\n        if (!auth.isLoggedIn) {\n            return false;\n        }\n        var info = auth.authInfo;\n        if (info === undefined) {\n            return false;\n        }\n        if (!info.isLoggedIn) {\n            return false;\n        }\n        var jwt;\n        try {\n            jwt = JWT.fromEncoded(info.accessToken);\n        }\n        catch (e) {\n            console.log(e);\n            return false;\n        }\n        if (Date.now() / 1000 < jwt.expires - EXPIRATION_WINDOW_SECS) {\n            return false;\n        }\n        return true;\n    };\n    AccessTokenRefresher.prototype.run = function () {\n        var _this = this;\n        if (!this.shouldRefresh()) {\n            this.nextTimeout = setTimeout(function () { return _this.run(); }, SLEEP_MILLIS);\n        }\n        else {\n            this.auth.refreshAccessToken().then(function () {\n                _this.nextTimeout = setTimeout(function () { return _this.run(); }, SLEEP_MILLIS);\n            }).catch(function () {\n                _this.nextTimeout = setTimeout(function () { return _this.run(); }, SLEEP_MILLIS);\n            });\n        }\n    };\n    AccessTokenRefresher.prototype.stop = function () {\n        clearTimeout(this.nextTimeout);\n    };\n    return AccessTokenRefresher;\n}());\nexport default AccessTokenRefresher;\n//# sourceMappingURL=AccessTokenRefresher.js.map"]},"metadata":{},"sourceType":"module"}
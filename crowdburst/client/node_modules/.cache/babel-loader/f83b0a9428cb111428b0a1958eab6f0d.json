{"ast":null,"code":"var __values = this && this.__values || function (o) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator],\n      i = 0;\n  if (m) return m.call(o);\n  return {\n    next: function () {\n      if (o && i >= o.length) o = void 0;\n      return {\n        value: o && o[i++],\n        done: !o\n      };\n    }\n  };\n};\n\nimport StitchError from \"../../StitchError\";\nimport StitchRequestError from \"../../StitchRequestError\";\nimport Event from \"./Event\";\nimport StitchEvent from \"./StitchEvent\";\n\nvar BaseEventStream = function () {\n  function BaseEventStream(reconnecter) {\n    this.reconnecter = reconnecter;\n    this.closed = false;\n    this.events = [];\n    this.listeners = [];\n    this.lastErr = undefined;\n  }\n\n  BaseEventStream.prototype.isOpen = function () {\n    return !this.closed;\n  };\n\n  BaseEventStream.prototype.addListener = function (listener) {\n    var _this = this;\n\n    if (this.closed) {\n      setTimeout(function () {\n        return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed\"));\n      }, 0);\n      return;\n    }\n\n    if (this.lastErr !== undefined) {\n      setTimeout(function () {\n        return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, _this.lastErr));\n      }, 0);\n      return;\n    }\n\n    this.listeners.push(listener);\n    this.poll();\n  };\n\n  BaseEventStream.prototype.removeListener = function (listener) {\n    var index = this.listeners.indexOf(listener);\n\n    if (index === -1) {\n      return;\n    }\n\n    this.listeners.splice(index, 1);\n  };\n\n  BaseEventStream.prototype.nextEvent = function () {\n    var _this = this;\n\n    if (this.closed) {\n      return Promise.reject(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed\"));\n    }\n\n    if (this.lastErr !== undefined) {\n      return Promise.reject(new Event(StitchEvent.ERROR_EVENT_NAME, this.lastErr));\n    }\n\n    return new Promise(function (resolve, reject) {\n      _this.listenOnce({\n        onEvent: function (e) {\n          resolve(e);\n        }\n      });\n    });\n  };\n\n  BaseEventStream.prototype.close = function () {\n    if (this.closed) {\n      return;\n    }\n\n    this.closed = true;\n    this.afterClose();\n  };\n\n  BaseEventStream.prototype.reconnect = function (error) {\n    var _this = this;\n\n    if (!this.reconnecter) {\n      if (!this.closed) {\n        this.closed = true;\n        this.events.push(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed: \" + error));\n        this.poll();\n      }\n\n      return;\n    }\n\n    this.reconnecter().then(function (next) {\n      _this.onReconnect(next);\n    }).catch(function (e) {\n      if (!(e instanceof StitchError) || !(e instanceof StitchRequestError)) {\n        _this.closed = true;\n\n        _this.events.push(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed: \" + error));\n\n        _this.poll();\n\n        return;\n      }\n\n      setTimeout(function () {\n        return _this.reconnect(e);\n      }, BaseEventStream.RETRY_TIMEOUT_MILLIS);\n    });\n  };\n\n  BaseEventStream.prototype.poll = function () {\n    var e_1, _a;\n\n    while (this.events.length !== 0) {\n      var event_1 = this.events.pop();\n\n      try {\n        for (var _b = __values(this.listeners), _c = _b.next(); !_c.done; _c = _b.next()) {\n          var listener = _c.value;\n\n          if (listener.onEvent) {\n            listener.onEvent(event_1);\n          }\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n    }\n  };\n\n  BaseEventStream.prototype.listenOnce = function (listener) {\n    var _this = this;\n\n    if (this.closed) {\n      setTimeout(function () {\n        return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed\"));\n      }, 0);\n      return;\n    }\n\n    if (this.lastErr !== undefined) {\n      setTimeout(function () {\n        return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, _this.lastErr));\n      }, 0);\n      return;\n    }\n\n    var wrapper = {\n      onEvent: function (e) {\n        _this.removeListener(wrapper);\n\n        listener.onEvent(e);\n      }\n    };\n    this.addListener(wrapper);\n  };\n\n  BaseEventStream.RETRY_TIMEOUT_MILLIS = 5000;\n  return BaseEventStream;\n}();\n\nexport default BaseEventStream;","map":{"version":3,"sources":["../../../../src/internal/net/BaseEventStream.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __values = (this && this.__values) || function (o) {\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator], i = 0;\n    if (m) return m.call(o);\n    return {\n        next: function () {\n            if (o && i >= o.length) o = void 0;\n            return { value: o && o[i++], done: !o };\n        }\n    };\n};\nimport StitchError from \"../../StitchError\";\nimport StitchRequestError from \"../../StitchRequestError\";\nimport Event from \"./Event\";\nimport StitchEvent from \"./StitchEvent\";\nvar BaseEventStream = (function () {\n    function BaseEventStream(reconnecter) {\n        this.reconnecter = reconnecter;\n        this.closed = false;\n        this.events = [];\n        this.listeners = [];\n        this.lastErr = undefined;\n    }\n    BaseEventStream.prototype.isOpen = function () {\n        return !this.closed;\n    };\n    BaseEventStream.prototype.addListener = function (listener) {\n        var _this = this;\n        if (this.closed) {\n            setTimeout(function () { return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed\")); }, 0);\n            return;\n        }\n        if (this.lastErr !== undefined) {\n            setTimeout(function () { return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, _this.lastErr)); }, 0);\n            return;\n        }\n        this.listeners.push(listener);\n        this.poll();\n    };\n    BaseEventStream.prototype.removeListener = function (listener) {\n        var index = this.listeners.indexOf(listener);\n        if (index === -1) {\n            return;\n        }\n        this.listeners.splice(index, 1);\n    };\n    BaseEventStream.prototype.nextEvent = function () {\n        var _this = this;\n        if (this.closed) {\n            return Promise.reject(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed\"));\n        }\n        if (this.lastErr !== undefined) {\n            return Promise.reject(new Event(StitchEvent.ERROR_EVENT_NAME, this.lastErr));\n        }\n        return new Promise(function (resolve, reject) {\n            _this.listenOnce({\n                onEvent: function (e) {\n                    resolve(e);\n                }\n            });\n        });\n    };\n    BaseEventStream.prototype.close = function () {\n        if (this.closed) {\n            return;\n        }\n        this.closed = true;\n        this.afterClose();\n    };\n    BaseEventStream.prototype.reconnect = function (error) {\n        var _this = this;\n        if (!this.reconnecter) {\n            if (!this.closed) {\n                this.closed = true;\n                this.events.push(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed: \" + error));\n                this.poll();\n            }\n            return;\n        }\n        this.reconnecter()\n            .then(function (next) {\n            _this.onReconnect(next);\n        })\n            .catch(function (e) {\n            if (!(e instanceof StitchError) || !(e instanceof StitchRequestError)) {\n                _this.closed = true;\n                _this.events.push(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed: \" + error));\n                _this.poll();\n                return;\n            }\n            setTimeout(function () { return _this.reconnect(e); }, BaseEventStream.RETRY_TIMEOUT_MILLIS);\n        });\n    };\n    BaseEventStream.prototype.poll = function () {\n        var e_1, _a;\n        while (this.events.length !== 0) {\n            var event_1 = this.events.pop();\n            try {\n                for (var _b = __values(this.listeners), _c = _b.next(); !_c.done; _c = _b.next()) {\n                    var listener = _c.value;\n                    if (listener.onEvent) {\n                        listener.onEvent(event_1);\n                    }\n                }\n            }\n            catch (e_1_1) { e_1 = { error: e_1_1 }; }\n            finally {\n                try {\n                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n                }\n                finally { if (e_1) throw e_1.error; }\n            }\n        }\n    };\n    BaseEventStream.prototype.listenOnce = function (listener) {\n        var _this = this;\n        if (this.closed) {\n            setTimeout(function () { return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, \"stream closed\")); }, 0);\n            return;\n        }\n        if (this.lastErr !== undefined) {\n            setTimeout(function () { return listener.onEvent(new Event(StitchEvent.ERROR_EVENT_NAME, _this.lastErr)); }, 0);\n            return;\n        }\n        var wrapper = {\n            onEvent: function (e) {\n                _this.removeListener(wrapper);\n                listener.onEvent(e);\n            }\n        };\n        this.addListener(wrapper);\n    };\n    BaseEventStream.RETRY_TIMEOUT_MILLIS = 5000;\n    return BaseEventStream;\n}());\nexport default BaseEventStream;\n//# sourceMappingURL=BaseEventStream.js.map"]},"metadata":{},"sourceType":"module"}
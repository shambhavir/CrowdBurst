{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var extendStatics = Object.setPrototypeOf || {\n    __proto__: []\n  } instanceof Array && function (d, b) {\n    d.__proto__ = b;\n  } || function (d, b) {\n    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nimport { detect } from \"detect-browser\";\nimport { AuthEventKind, AuthInfo, CoreStitchAuth, DeviceFields, StitchAuthResponseCredential, StitchClientError, StitchClientErrorCode } from \"mongodb-stitch-core-sdk\";\nimport version from \"../../internal/common/Version\";\nimport RedirectFragmentFields from \"./RedirectFragmentFields\";\nimport RedirectKeys from \"./RedirectKeys\";\nimport StitchRedirectError from \"./StitchRedirectError\";\nimport StitchUserFactoryImpl from \"./StitchUserFactoryImpl\";\nvar alphaNumericCharacters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\n\nvar StitchAuthImpl = function (_super) {\n  __extends(StitchAuthImpl, _super);\n\n  function StitchAuthImpl(requestClient, browserAuthRoutes, authStorage, appInfo, jsdomWindow) {\n    if (jsdomWindow === void 0) {\n      jsdomWindow = window;\n    }\n\n    var _this = _super.call(this, requestClient, browserAuthRoutes, authStorage) || this;\n\n    _this.browserAuthRoutes = browserAuthRoutes;\n    _this.authStorage = authStorage;\n    _this.appInfo = appInfo;\n    _this.jsdomWindow = jsdomWindow;\n    _this.listeners = new Set();\n    _this.synchronousListeners = new Set();\n    return _this;\n  }\n\n  Object.defineProperty(StitchAuthImpl.prototype, \"userFactory\", {\n    get: function () {\n      return new StitchUserFactoryImpl(this);\n    },\n    enumerable: true,\n    configurable: true\n  });\n\n  StitchAuthImpl.prototype.getProviderClient = function (factory, providerName) {\n    if (isAuthProviderClientFactory(factory)) {\n      return factory.getClient(this, this.requestClient, this.authRoutes);\n    } else {\n      return factory.getNamedClient(providerName, this.requestClient, this.authRoutes);\n    }\n  };\n\n  StitchAuthImpl.prototype.loginWithCredential = function (credential) {\n    return _super.prototype.loginWithCredentialInternal.call(this, credential);\n  };\n\n  StitchAuthImpl.prototype.loginWithRedirect = function (credential) {\n    var _this = this;\n\n    var _a = this.prepareRedirect(credential),\n        redirectUrl = _a.redirectUrl,\n        state = _a.state;\n\n    this.requestClient.getBaseURL().then(function (baseUrl) {\n      _this.jsdomWindow.location.replace(baseUrl + _this.browserAuthRoutes.getAuthProviderRedirectRoute(credential, redirectUrl, state, _this.deviceInfo));\n    });\n  };\n\n  StitchAuthImpl.prototype.linkWithRedirectInternal = function (user, credential) {\n    var _this = this;\n\n    if (this.user !== undefined && user.id !== this.user.id) {\n      return Promise.reject(new StitchClientError(StitchClientErrorCode.UserNoLongerValid));\n    }\n\n    var _a = this.prepareRedirect(credential),\n        redirectUrl = _a.redirectUrl,\n        state = _a.state;\n\n    return this.requestClient.getBaseURL().then(function (baseUrl) {\n      var link = baseUrl + _this.browserAuthRoutes.getAuthProviderLinkRedirectRoute(credential, redirectUrl, state, _this.deviceInfo);\n\n      return (StitchAuthImpl.injectedFetch ? StitchAuthImpl.injectedFetch : fetch)(new Request(link, {\n        credentials: \"include\",\n        headers: {\n          Authorization: \"Bearer \" + _this.authInfo.accessToken\n        },\n        mode: 'cors'\n      }));\n    }).then(function (response) {\n      _this.jsdomWindow.location.replace(response.headers.get(\"X-Stitch-Location\"));\n    });\n  };\n\n  StitchAuthImpl.prototype.hasRedirectResult = function () {\n    var isValid = false;\n\n    try {\n      isValid = this.parseRedirect().isValid;\n      return isValid;\n    } catch (_) {\n      return false;\n    } finally {\n      if (!isValid) {\n        this.cleanupRedirect();\n      }\n    }\n  };\n\n  StitchAuthImpl.prototype.handleRedirectResult = function () {\n    try {\n      var providerName = this.authStorage.get(RedirectKeys.ProviderName);\n      var providerType = this.authStorage.get(RedirectKeys.ProviderType);\n      var redirectFragment = this.parseRedirect();\n      return this.loginWithCredentialInternal(new StitchAuthResponseCredential(this.processRedirectResult(redirectFragment), providerType, providerName, redirectFragment.asLink)).then(function (user) {\n        return user;\n      });\n    } catch (err) {\n      return Promise.reject(err);\n    }\n  };\n\n  StitchAuthImpl.prototype.linkWithCredential = function (user, credential) {\n    return _super.prototype.linkUserWithCredentialInternal.call(this, user, credential);\n  };\n\n  StitchAuthImpl.prototype.logout = function () {\n    if (arguments.length > 0) {\n      return Promise.reject(new StitchClientError(StitchClientErrorCode.UnexpectedArguments));\n    }\n\n    return _super.prototype.logoutInternal.call(this);\n  };\n\n  StitchAuthImpl.prototype.logoutUserWithId = function (userId) {\n    return _super.prototype.logoutUserWithIdInternal.call(this, userId);\n  };\n\n  StitchAuthImpl.prototype.removeUser = function () {\n    if (arguments.length > 0) {\n      return Promise.reject(new StitchClientError(StitchClientErrorCode.UnexpectedArguments));\n    }\n\n    return _super.prototype.removeUserInternal.call(this);\n  };\n\n  StitchAuthImpl.prototype.removeUserWithId = function (userId) {\n    return _super.prototype.removeUserWithIdInternal.call(this, userId);\n  };\n\n  Object.defineProperty(StitchAuthImpl.prototype, \"deviceInfo\", {\n    get: function () {\n      var info = {};\n\n      if (this.hasDeviceId) {\n        info[DeviceFields.DEVICE_ID] = this.deviceId;\n      }\n\n      if (this.appInfo.localAppName !== undefined) {\n        info[DeviceFields.APP_ID] = this.appInfo.localAppName;\n      }\n\n      if (this.appInfo.localAppVersion !== undefined) {\n        info[DeviceFields.APP_VERSION] = this.appInfo.localAppVersion;\n      }\n\n      var browser = detect();\n\n      if (browser) {\n        info[DeviceFields.PLATFORM] = browser.name;\n        info[DeviceFields.PLATFORM_VERSION] = browser.version;\n      } else {\n        info[DeviceFields.PLATFORM] = \"web\";\n        info[DeviceFields.PLATFORM_VERSION] = \"0.0.0\";\n      }\n\n      info[DeviceFields.SDK_VERSION] = version;\n      return info;\n    },\n    enumerable: true,\n    configurable: true\n  });\n\n  StitchAuthImpl.prototype.addAuthListener = function (listener) {\n    this.listeners.add(listener);\n    this.onAuthEvent(listener);\n    this.dispatchAuthEvent({\n      kind: AuthEventKind.ListenerRegistered\n    });\n  };\n\n  StitchAuthImpl.prototype.addSynchronousAuthListener = function (listener) {\n    this.listeners.add(listener);\n    this.onAuthEvent(listener);\n    this.dispatchAuthEvent({\n      kind: AuthEventKind.ListenerRegistered\n    });\n  };\n\n  StitchAuthImpl.prototype.removeAuthListener = function (listener) {\n    this.listeners.delete(listener);\n  };\n\n  StitchAuthImpl.prototype.onAuthEvent = function (listener) {\n    var _this = this;\n\n    if (listener) {\n      var _1 = new Promise(function (resolve) {\n        if (listener.onAuthEvent) {\n          listener.onAuthEvent(_this);\n        }\n\n        resolve(undefined);\n      });\n    } else {\n      this.listeners.forEach(function (one) {\n        _this.onAuthEvent(one);\n      });\n    }\n  };\n\n  StitchAuthImpl.prototype.dispatchAuthEvent = function (event) {\n    var _this = this;\n\n    switch (event.kind) {\n      case AuthEventKind.ActiveUserChanged:\n        this.dispatchBlockToListeners(function (listener) {\n          if (listener.onActiveUserChanged) {\n            listener.onActiveUserChanged(_this, event.currentActiveUser, event.previousActiveUser);\n          }\n        });\n        break;\n\n      case AuthEventKind.ListenerRegistered:\n        this.dispatchBlockToListeners(function (listener) {\n          if (listener.onListenerRegistered) {\n            listener.onListenerRegistered(_this);\n          }\n        });\n        break;\n\n      case AuthEventKind.UserAdded:\n        this.dispatchBlockToListeners(function (listener) {\n          if (listener.onUserAdded) {\n            listener.onUserAdded(_this, event.addedUser);\n          }\n        });\n        break;\n\n      case AuthEventKind.UserLinked:\n        this.dispatchBlockToListeners(function (listener) {\n          if (listener.onUserLinked) {\n            listener.onUserLinked(_this, event.linkedUser);\n          }\n        });\n        break;\n\n      case AuthEventKind.UserLoggedIn:\n        this.dispatchBlockToListeners(function (listener) {\n          if (listener.onUserLoggedIn) {\n            listener.onUserLoggedIn(_this, event.loggedInUser);\n          }\n        });\n        break;\n\n      case AuthEventKind.UserLoggedOut:\n        this.dispatchBlockToListeners(function (listener) {\n          if (listener.onUserLoggedOut) {\n            listener.onUserLoggedOut(_this, event.loggedOutUser);\n          }\n        });\n        break;\n\n      case AuthEventKind.UserRemoved:\n        this.dispatchBlockToListeners(function (listener) {\n          if (listener.onUserRemoved) {\n            listener.onUserRemoved(_this, event.removedUser);\n          }\n        });\n        break;\n\n      default:\n        return this.assertNever(event);\n    }\n  };\n\n  StitchAuthImpl.prototype.refreshCustomData = function () {\n    return this.refreshAccessToken();\n  };\n\n  StitchAuthImpl.prototype.assertNever = function (x) {\n    throw new Error(\"unexpected object: \" + x);\n  };\n\n  StitchAuthImpl.prototype.dispatchBlockToListeners = function (block) {\n    this.synchronousListeners.forEach(block);\n    this.listeners.forEach(function (listener) {\n      var _ = new Promise(function (resolve) {\n        block(listener);\n        resolve(undefined);\n      });\n    });\n  };\n\n  StitchAuthImpl.prototype.cleanupRedirect = function () {\n    this.jsdomWindow.history.replaceState(null, \"\", this.pageRootUrl());\n    this.authStorage.remove(RedirectKeys.State);\n    this.authStorage.remove(RedirectKeys.ProviderName);\n    this.authStorage.remove(RedirectKeys.ProviderType);\n  };\n\n  StitchAuthImpl.prototype.parseRedirect = function () {\n    if (typeof this.jsdomWindow === \"undefined\") {\n      throw new StitchRedirectError(\"running in a non-browser environment\");\n    }\n\n    if (!this.jsdomWindow.location || !this.jsdomWindow.location.hash) {\n      throw new StitchRedirectError(\"window location hash was undefined\");\n    }\n\n    var ourState = this.authStorage.get(RedirectKeys.State);\n    var redirectFragment = this.jsdomWindow.location.hash.substring(1);\n    return parseRedirectFragment(redirectFragment, ourState, this.appInfo.clientAppId);\n  };\n\n  StitchAuthImpl.prototype.processRedirectResult = function (redirectFragment) {\n    try {\n      if (!redirectFragment.isValid) {\n        throw new StitchRedirectError(\"invalid redirect result\");\n      }\n\n      if (redirectFragment.lastError) {\n        throw new StitchRedirectError(\"error handling redirect: \" + redirectFragment.lastError);\n      }\n\n      if (!redirectFragment.authInfo) {\n        throw new StitchRedirectError(\"no user auth value was found: it could not be decoded from fragment\");\n      }\n    } catch (err) {\n      throw err;\n    } finally {\n      this.cleanupRedirect();\n    }\n\n    return redirectFragment.authInfo;\n  };\n\n  StitchAuthImpl.prototype.prepareRedirect = function (credential) {\n    this.authStorage.set(RedirectKeys.ProviderName, credential.providerName);\n    this.authStorage.set(RedirectKeys.ProviderType, credential.providerType);\n    var redirectUrl = credential.redirectUrl;\n\n    if (redirectUrl === undefined) {\n      redirectUrl = this.pageRootUrl();\n    }\n\n    var state = generateState();\n    this.authStorage.set(RedirectKeys.State, state);\n    return {\n      redirectUrl: redirectUrl,\n      state: state\n    };\n  };\n\n  StitchAuthImpl.prototype.pageRootUrl = function () {\n    return [this.jsdomWindow.location.protocol, \"//\", this.jsdomWindow.location.host, this.jsdomWindow.location.pathname].join(\"\");\n  };\n\n  return StitchAuthImpl;\n}(CoreStitchAuth);\n\nexport default StitchAuthImpl;\n\nfunction generateState() {\n  var state = \"\";\n\n  for (var i = 0; i < 64; ++i) {\n    state += alphaNumericCharacters.charAt(Math.floor(Math.random() * alphaNumericCharacters.length));\n  }\n\n  return state;\n}\n\nfunction unmarshallUserAuth(data) {\n  var parts = data.split(\"$\");\n\n  if (parts.length !== 4) {\n    throw new StitchRedirectError(\"invalid user auth data provided while \" + \"marshalling user authentication data: \" + data);\n  }\n\n  var _a = __read(parts, 4),\n      accessToken = _a[0],\n      refreshToken = _a[1],\n      userId = _a[2],\n      deviceId = _a[3];\n\n  return new AuthInfo(userId, deviceId, accessToken, refreshToken);\n}\n\nvar ParsedRedirectFragment = function () {\n  function ParsedRedirectFragment() {\n    this.stateValid = false;\n    this.clientAppIdValid = false;\n    this.asLink = false;\n  }\n\n  Object.defineProperty(ParsedRedirectFragment.prototype, \"isValid\", {\n    get: function () {\n      return this.stateValid && this.clientAppIdValid;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  return ParsedRedirectFragment;\n}();\n\nfunction parseRedirectFragment(fragment, ourState, ourClientAppId) {\n  var vars = fragment.split(\"&\");\n  var result = new ParsedRedirectFragment();\n  vars.forEach(function (kvp) {\n    var pairParts = kvp.split(\"=\");\n    var pairKey = decodeURIComponent(pairParts[0]);\n\n    switch (pairKey) {\n      case RedirectFragmentFields.StitchError:\n        result.lastError = decodeURIComponent(pairParts[1]);\n        break;\n\n      case RedirectFragmentFields.UserAuth:\n        try {\n          result.authInfo = unmarshallUserAuth(decodeURIComponent(pairParts[1]));\n        } catch (e) {\n          result.lastError = e;\n        }\n\n        break;\n\n      case RedirectFragmentFields.StitchLink:\n        if (pairParts[1] === \"ok\") {\n          result.asLink = true;\n        }\n\n        break;\n\n      case RedirectFragmentFields.State:\n        var theirState = decodeURIComponent(pairParts[1]);\n\n        if (ourState === theirState) {\n          result.stateValid = true;\n        }\n\n        break;\n\n      case RedirectFragmentFields.ClientAppId:\n        var clientAppId = decodeURIComponent(pairParts[1]);\n\n        if (ourClientAppId === clientAppId) {\n          result.clientAppIdValid = true;\n        }\n\n        break;\n\n      default:\n        break;\n    }\n  });\n  return result;\n}\n\nfunction isAuthProviderClientFactory(factory) {\n  return factory.getClient !== undefined;\n}","map":{"version":3,"sources":["../../../../../src/core/auth/internal/StitchAuthImpl.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __read = (this && this.__read) || function (o, n) {\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n    if (!m) return o;\n    var i = m.call(o), r, ar = [], e;\n    try {\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n    }\n    catch (error) { e = { error: error }; }\n    finally {\n        try {\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\n        }\n        finally { if (e) throw e.error; }\n    }\n    return ar;\n};\nimport { detect } from \"detect-browser\";\nimport { AuthEventKind, AuthInfo, CoreStitchAuth, DeviceFields, StitchAuthResponseCredential, StitchClientError, StitchClientErrorCode } from \"mongodb-stitch-core-sdk\";\nimport version from \"../../internal/common/Version\";\nimport RedirectFragmentFields from \"./RedirectFragmentFields\";\nimport RedirectKeys from \"./RedirectKeys\";\nimport StitchRedirectError from \"./StitchRedirectError\";\nimport StitchUserFactoryImpl from \"./StitchUserFactoryImpl\";\nvar alphaNumericCharacters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\nvar StitchAuthImpl = (function (_super) {\n    __extends(StitchAuthImpl, _super);\n    function StitchAuthImpl(requestClient, browserAuthRoutes, authStorage, appInfo, jsdomWindow) {\n        if (jsdomWindow === void 0) { jsdomWindow = window; }\n        var _this = _super.call(this, requestClient, browserAuthRoutes, authStorage) || this;\n        _this.browserAuthRoutes = browserAuthRoutes;\n        _this.authStorage = authStorage;\n        _this.appInfo = appInfo;\n        _this.jsdomWindow = jsdomWindow;\n        _this.listeners = new Set();\n        _this.synchronousListeners = new Set();\n        return _this;\n    }\n    Object.defineProperty(StitchAuthImpl.prototype, \"userFactory\", {\n        get: function () {\n            return new StitchUserFactoryImpl(this);\n        },\n        enumerable: true,\n        configurable: true\n    });\n    StitchAuthImpl.prototype.getProviderClient = function (factory, providerName) {\n        if (isAuthProviderClientFactory(factory)) {\n            return factory.getClient(this, this.requestClient, this.authRoutes);\n        }\n        else {\n            return factory.getNamedClient(providerName, this.requestClient, this.authRoutes);\n        }\n    };\n    StitchAuthImpl.prototype.loginWithCredential = function (credential) {\n        return _super.prototype.loginWithCredentialInternal.call(this, credential);\n    };\n    StitchAuthImpl.prototype.loginWithRedirect = function (credential) {\n        var _this = this;\n        var _a = this.prepareRedirect(credential), redirectUrl = _a.redirectUrl, state = _a.state;\n        this.requestClient.getBaseURL().then(function (baseUrl) {\n            _this.jsdomWindow.location.replace(baseUrl +\n                _this.browserAuthRoutes.getAuthProviderRedirectRoute(credential, redirectUrl, state, _this.deviceInfo));\n        });\n    };\n    StitchAuthImpl.prototype.linkWithRedirectInternal = function (user, credential) {\n        var _this = this;\n        if (this.user !== undefined && user.id !== this.user.id) {\n            return Promise.reject(new StitchClientError(StitchClientErrorCode.UserNoLongerValid));\n        }\n        var _a = this.prepareRedirect(credential), redirectUrl = _a.redirectUrl, state = _a.state;\n        return this.requestClient.getBaseURL().then(function (baseUrl) {\n            var link = baseUrl +\n                _this.browserAuthRoutes.getAuthProviderLinkRedirectRoute(credential, redirectUrl, state, _this.deviceInfo);\n            return (StitchAuthImpl.injectedFetch ? StitchAuthImpl.injectedFetch : fetch)(new Request(link, {\n                credentials: \"include\",\n                headers: {\n                    Authorization: \"Bearer \" + _this.authInfo.accessToken\n                },\n                mode: 'cors'\n            }));\n        }).then(function (response) {\n            _this.jsdomWindow.location.replace(response.headers.get(\"X-Stitch-Location\"));\n        });\n    };\n    StitchAuthImpl.prototype.hasRedirectResult = function () {\n        var isValid = false;\n        try {\n            isValid = this.parseRedirect().isValid;\n            return isValid;\n        }\n        catch (_) {\n            return false;\n        }\n        finally {\n            if (!isValid) {\n                this.cleanupRedirect();\n            }\n        }\n    };\n    StitchAuthImpl.prototype.handleRedirectResult = function () {\n        try {\n            var providerName = this.authStorage.get(RedirectKeys.ProviderName);\n            var providerType = this.authStorage.get(RedirectKeys.ProviderType);\n            var redirectFragment = this.parseRedirect();\n            return this.loginWithCredentialInternal(new StitchAuthResponseCredential(this.processRedirectResult(redirectFragment), providerType, providerName, redirectFragment.asLink)).then(function (user) { return user; });\n        }\n        catch (err) {\n            return Promise.reject(err);\n        }\n    };\n    StitchAuthImpl.prototype.linkWithCredential = function (user, credential) {\n        return _super.prototype.linkUserWithCredentialInternal.call(this, user, credential);\n    };\n    StitchAuthImpl.prototype.logout = function () {\n        if (arguments.length > 0) {\n            return Promise.reject(new StitchClientError(StitchClientErrorCode.UnexpectedArguments));\n        }\n        return _super.prototype.logoutInternal.call(this);\n    };\n    StitchAuthImpl.prototype.logoutUserWithId = function (userId) {\n        return _super.prototype.logoutUserWithIdInternal.call(this, userId);\n    };\n    StitchAuthImpl.prototype.removeUser = function () {\n        if (arguments.length > 0) {\n            return Promise.reject(new StitchClientError(StitchClientErrorCode.UnexpectedArguments));\n        }\n        return _super.prototype.removeUserInternal.call(this);\n    };\n    StitchAuthImpl.prototype.removeUserWithId = function (userId) {\n        return _super.prototype.removeUserWithIdInternal.call(this, userId);\n    };\n    Object.defineProperty(StitchAuthImpl.prototype, \"deviceInfo\", {\n        get: function () {\n            var info = {};\n            if (this.hasDeviceId) {\n                info[DeviceFields.DEVICE_ID] = this.deviceId;\n            }\n            if (this.appInfo.localAppName !== undefined) {\n                info[DeviceFields.APP_ID] = this.appInfo.localAppName;\n            }\n            if (this.appInfo.localAppVersion !== undefined) {\n                info[DeviceFields.APP_VERSION] = this.appInfo.localAppVersion;\n            }\n            var browser = detect();\n            if (browser) {\n                info[DeviceFields.PLATFORM] = browser.name;\n                info[DeviceFields.PLATFORM_VERSION] = browser.version;\n            }\n            else {\n                info[DeviceFields.PLATFORM] = \"web\";\n                info[DeviceFields.PLATFORM_VERSION] = \"0.0.0\";\n            }\n            info[DeviceFields.SDK_VERSION] = version;\n            return info;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    StitchAuthImpl.prototype.addAuthListener = function (listener) {\n        this.listeners.add(listener);\n        this.onAuthEvent(listener);\n        this.dispatchAuthEvent({\n            kind: AuthEventKind.ListenerRegistered,\n        });\n    };\n    StitchAuthImpl.prototype.addSynchronousAuthListener = function (listener) {\n        this.listeners.add(listener);\n        this.onAuthEvent(listener);\n        this.dispatchAuthEvent({\n            kind: AuthEventKind.ListenerRegistered,\n        });\n    };\n    StitchAuthImpl.prototype.removeAuthListener = function (listener) {\n        this.listeners.delete(listener);\n    };\n    StitchAuthImpl.prototype.onAuthEvent = function (listener) {\n        var _this = this;\n        if (listener) {\n            var _1 = new Promise(function (resolve) {\n                if (listener.onAuthEvent) {\n                    listener.onAuthEvent(_this);\n                }\n                resolve(undefined);\n            });\n        }\n        else {\n            this.listeners.forEach(function (one) {\n                _this.onAuthEvent(one);\n            });\n        }\n    };\n    StitchAuthImpl.prototype.dispatchAuthEvent = function (event) {\n        var _this = this;\n        switch (event.kind) {\n            case AuthEventKind.ActiveUserChanged:\n                this.dispatchBlockToListeners(function (listener) {\n                    if (listener.onActiveUserChanged) {\n                        listener.onActiveUserChanged(_this, event.currentActiveUser, event.previousActiveUser);\n                    }\n                });\n                break;\n            case AuthEventKind.ListenerRegistered:\n                this.dispatchBlockToListeners(function (listener) {\n                    if (listener.onListenerRegistered) {\n                        listener.onListenerRegistered(_this);\n                    }\n                });\n                break;\n            case AuthEventKind.UserAdded:\n                this.dispatchBlockToListeners(function (listener) {\n                    if (listener.onUserAdded) {\n                        listener.onUserAdded(_this, event.addedUser);\n                    }\n                });\n                break;\n            case AuthEventKind.UserLinked:\n                this.dispatchBlockToListeners(function (listener) {\n                    if (listener.onUserLinked) {\n                        listener.onUserLinked(_this, event.linkedUser);\n                    }\n                });\n                break;\n            case AuthEventKind.UserLoggedIn:\n                this.dispatchBlockToListeners(function (listener) {\n                    if (listener.onUserLoggedIn) {\n                        listener.onUserLoggedIn(_this, event.loggedInUser);\n                    }\n                });\n                break;\n            case AuthEventKind.UserLoggedOut:\n                this.dispatchBlockToListeners(function (listener) {\n                    if (listener.onUserLoggedOut) {\n                        listener.onUserLoggedOut(_this, event.loggedOutUser);\n                    }\n                });\n                break;\n            case AuthEventKind.UserRemoved:\n                this.dispatchBlockToListeners(function (listener) {\n                    if (listener.onUserRemoved) {\n                        listener.onUserRemoved(_this, event.removedUser);\n                    }\n                });\n                break;\n            default:\n                return this.assertNever(event);\n        }\n    };\n    StitchAuthImpl.prototype.refreshCustomData = function () {\n        return this.refreshAccessToken();\n    };\n    StitchAuthImpl.prototype.assertNever = function (x) {\n        throw new Error(\"unexpected object: \" + x);\n    };\n    StitchAuthImpl.prototype.dispatchBlockToListeners = function (block) {\n        this.synchronousListeners.forEach(block);\n        this.listeners.forEach(function (listener) {\n            var _ = new Promise(function (resolve) {\n                block(listener);\n                resolve(undefined);\n            });\n        });\n    };\n    StitchAuthImpl.prototype.cleanupRedirect = function () {\n        this.jsdomWindow.history.replaceState(null, \"\", this.pageRootUrl());\n        this.authStorage.remove(RedirectKeys.State);\n        this.authStorage.remove(RedirectKeys.ProviderName);\n        this.authStorage.remove(RedirectKeys.ProviderType);\n    };\n    StitchAuthImpl.prototype.parseRedirect = function () {\n        if (typeof this.jsdomWindow === \"undefined\") {\n            throw new StitchRedirectError(\"running in a non-browser environment\");\n        }\n        if (!this.jsdomWindow.location || !this.jsdomWindow.location.hash) {\n            throw new StitchRedirectError(\"window location hash was undefined\");\n        }\n        var ourState = this.authStorage.get(RedirectKeys.State);\n        var redirectFragment = this.jsdomWindow.location.hash.substring(1);\n        return parseRedirectFragment(redirectFragment, ourState, this.appInfo.clientAppId);\n    };\n    StitchAuthImpl.prototype.processRedirectResult = function (redirectFragment) {\n        try {\n            if (!redirectFragment.isValid) {\n                throw new StitchRedirectError(\"invalid redirect result\");\n            }\n            if (redirectFragment.lastError) {\n                throw new StitchRedirectError(\"error handling redirect: \" + redirectFragment.lastError);\n            }\n            if (!redirectFragment.authInfo) {\n                throw new StitchRedirectError(\"no user auth value was found: it could not be decoded from fragment\");\n            }\n        }\n        catch (err) {\n            throw err;\n        }\n        finally {\n            this.cleanupRedirect();\n        }\n        return redirectFragment.authInfo;\n    };\n    StitchAuthImpl.prototype.prepareRedirect = function (credential) {\n        this.authStorage.set(RedirectKeys.ProviderName, credential.providerName);\n        this.authStorage.set(RedirectKeys.ProviderType, credential.providerType);\n        var redirectUrl = credential.redirectUrl;\n        if (redirectUrl === undefined) {\n            redirectUrl = this.pageRootUrl();\n        }\n        var state = generateState();\n        this.authStorage.set(RedirectKeys.State, state);\n        return { redirectUrl: redirectUrl, state: state };\n    };\n    StitchAuthImpl.prototype.pageRootUrl = function () {\n        return [\n            this.jsdomWindow.location.protocol,\n            \"//\",\n            this.jsdomWindow.location.host,\n            this.jsdomWindow.location.pathname\n        ].join(\"\");\n    };\n    return StitchAuthImpl;\n}(CoreStitchAuth));\nexport default StitchAuthImpl;\nfunction generateState() {\n    var state = \"\";\n    for (var i = 0; i < 64; ++i) {\n        state += alphaNumericCharacters.charAt(Math.floor(Math.random() * alphaNumericCharacters.length));\n    }\n    return state;\n}\nfunction unmarshallUserAuth(data) {\n    var parts = data.split(\"$\");\n    if (parts.length !== 4) {\n        throw new StitchRedirectError(\"invalid user auth data provided while \" +\n            \"marshalling user authentication data: \" +\n            data);\n    }\n    var _a = __read(parts, 4), accessToken = _a[0], refreshToken = _a[1], userId = _a[2], deviceId = _a[3];\n    return new AuthInfo(userId, deviceId, accessToken, refreshToken);\n}\nvar ParsedRedirectFragment = (function () {\n    function ParsedRedirectFragment() {\n        this.stateValid = false;\n        this.clientAppIdValid = false;\n        this.asLink = false;\n    }\n    Object.defineProperty(ParsedRedirectFragment.prototype, \"isValid\", {\n        get: function () {\n            return this.stateValid && this.clientAppIdValid;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    return ParsedRedirectFragment;\n}());\nfunction parseRedirectFragment(fragment, ourState, ourClientAppId) {\n    var vars = fragment.split(\"&\");\n    var result = new ParsedRedirectFragment();\n    vars.forEach(function (kvp) {\n        var pairParts = kvp.split(\"=\");\n        var pairKey = decodeURIComponent(pairParts[0]);\n        switch (pairKey) {\n            case RedirectFragmentFields.StitchError:\n                result.lastError = decodeURIComponent(pairParts[1]);\n                break;\n            case RedirectFragmentFields.UserAuth:\n                try {\n                    result.authInfo = unmarshallUserAuth(decodeURIComponent(pairParts[1]));\n                }\n                catch (e) {\n                    result.lastError = e;\n                }\n                break;\n            case RedirectFragmentFields.StitchLink:\n                if (pairParts[1] === \"ok\") {\n                    result.asLink = true;\n                }\n                break;\n            case RedirectFragmentFields.State:\n                var theirState = decodeURIComponent(pairParts[1]);\n                if (ourState === theirState) {\n                    result.stateValid = true;\n                }\n                break;\n            case RedirectFragmentFields.ClientAppId:\n                var clientAppId = decodeURIComponent(pairParts[1]);\n                if (ourClientAppId === clientAppId) {\n                    result.clientAppIdValid = true;\n                }\n                break;\n            default:\n                break;\n        }\n    });\n    return result;\n}\nfunction isAuthProviderClientFactory(factory) {\n    return (factory.getClient !== undefined);\n}\n//# sourceMappingURL=StitchAuthImpl.js.map"]},"metadata":{},"sourceType":"module"}